# Elasticsearch/Lucene의 Refresh, Flush, fsync 개념 정리

Elasticsearch와 그 기반이 되는 Lucene에서 `refresh`, `flush`, `fsync`는 데이터가 메모리에서 디스크로 저장되는 과정을 이해하는 데 핵심적인 개념입니다. 이들은 **검색 속도(Performance)**와 **데이터 안정성(Durability)** 사이의 균형을 맞추는 중요한 역할을 합니다.

---

## 🎯 핵심 요약

* **`Refresh`**: 새로 색인된 문서를 **검색 가능**하게 만듭니다. (Near Real-Time의 핵심)
* **`Flush`**: 메모리의 데이터를 **디스크에 영구적으로 저장**하여 안정성을 보장합니다. (Durability의 핵심)

---

## ⚙️ 데이터 흐름과 주요 개념

Elasticsearch의 데이터는 다음과 같은 흐름으로 처리됩니다. 이 과정을 제어하는 것이 바로 `Refresh`와 `Flush`입니다.

**In-memory Buffer → Filesystem Cache (검색 가능) → Disk (영구 저장)**

### 1. Refresh (리프레시) 🔄

* **목적**: In-memory buffer에 있는 문서를 검색 가능(Searchable)하게 만드는 작업입니다.
* **동작 방식**: In-memory buffer의 문서를 OS의 **파일 시스템 캐시(Filesystem Cache)**에 `세그먼트(segment)`라는 작은 파일 단위로 기록합니다.
* **핵심 특징**:
    * `refresh`가 실행된 문서는 검색 결과에 노출됩니다.
    * 데이터가 아직 물리적 디스크에 저장된 것은 아니므로, 시스템 장애 시 데이터가 유실될 수 있습니다.
    * 비용이 비교적 저렴하며, 기본적으로 **1초마다 자동으로 실행**됩니다 (`index.refresh_interval: "1s"`).
    * 이 특징 때문에 Elasticsearch를 "실시간(Real-Time)"이 아닌 **"거의 실시간(NRT, Near Real-Time)"** 검색 엔진이라고 부릅니다.

> **비유**: 워드 프로세서의 '자동 임시 저장' 기능과 같습니다. 문서를 즉시 열어볼 수 있지만, 완벽하게 저장된 상태는 아닙니다.

### 2. Flush (플러시) 💾

* **목적**: 파일 시스템 캐시에 있는 데이터를 물리적 디스크에 영구적으로 저장(Durable)하여 데이터 안정성을 보장하는 작업입니다.
* **동작 방식**: 내부적으로 **Lucene Commit**을 수행하며, 이 과정에서 `fsync` 시스템 콜을 호출하여 파일 시스템 캐시의 내용을 디스크에 동기화합니다.
* **핵심 특징**:
    * **데이터의 영속성(Durability)**을 보장하여 시스템이 다운되어도 데이터가 안전합니다.
    * 완료 후, 데이터 복구에 사용된 **트랜잭션 로그(Translog)의 일부를 삭제**하여 공간을 확보합니다.
    * `refresh`에 비해 디스크 I/O를 직접 유발하므로 비용이 매우 비쌉니다.
    * **자동 실행 조건**:
        * 기본적으로 **30분마다**
        * 트랜잭션 로그(Translog)가 특정 크기(기본 512MB)를 초과할 때
        * 수동으로 `_flush` API 호출 시

> **비유**: 워드 프로세서에서 `Ctrl + S`를 눌러 문서를 '완전히 저장'하는 것과 같습니다. 이 시점부터 파일은 안전하게 보존됩니다.

### 3. fsync (파일 시스템 동기화) ⚙️

`flush` 과정에서 사용되는 **OS 레벨의 시스템 콜(System Call)**입니다. OS에게 파일 시스템 캐시의 데이터를 즉시 물리적 디스크에 동기화하도록 명령하여 데이터의 영속성을 최종적으로 보장하는 역할을 합니다.

---

## 📊 한눈에 보는 비교표

| 개념 | 주요 목적 | 데이터 위치 | 동작 주기 (기본값) | I/O 비용 |
| :--- | :--- | :--- | :--- | :--- |
| **Refresh** | 검색 가능 (Searchable) | In-memory Buffer → **Filesystem Cache** | 1초 | 낮음 |
| **Flush** | 영구 저장 (Durable) | Filesystem Cache → **Physical Disk** | 30분 또는 Translog 512MB | 높음 |

---

## 🚀 데이터 색인부터 저장까지의 과정

1.  **색인 요청**: 클라이언트가 Elasticsearch에 문서 색인을 요청합니다.
2.  **In-Memory Buffer & Translog**:
    * 문서는 먼저 **In-memory buffer**에 저장됩니다.
    * 동시에 데이터 유실 방지를 위해 모든 변경 사항이 **트랜잭션 로그(Translog)** 파일에 기록됩니다.
3.  **Refresh (1초마다)**:
    * In-memory buffer의 내용이 파일 시스템 캐시에 새로운 **세그먼트**로 기록됩니다.
    * **이 시점부터 문서는 검색이 가능해집니다.**
4.  **Flush (주기적으로)**:
    * 파일 시스템 캐시에 있는 세그먼트들이 `fsync`를 통해 **물리적 디스크로 완전히 저장**됩니다.
    * 이후 불필요해진 트랜잭션 로그는 삭제됩니다.

---

## ✍️ 결론

`Refresh`는 검색 속도를, `Flush`는 데이터 안정성을 담당합니다. Elasticsearch는 이 두 가지 작업을 효과적으로 분리하고 서로 다른 주기로 실행함으로써, 거의 실시간에 가까운 빠른 검색 성능과 데이터의 영속성을 동시에 만족시키는 효율적인 구조를 갖추고 있습니다.