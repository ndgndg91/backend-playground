
# CQRS 아키텍처 다이어그램

이 다이어그램은 포인트 시스템의 지급, 사용, 조회 등 주요 기능이 CQRS 패턴 하에서 어떻게 동작하는지를 보여줍니다.

- **Command Flow (명령 흐름)**: 데이터 변경 요청 (지급, 사용, 소멸)
- **Query Flow (조회 흐름)**: 데이터 조회 요청 (잔액 조회, 내역 조회)

```
                               +-------------------------+
                               |      Client / User      |
                               +-----------+-------------+
                                           |
                  (API Request: 지급/사용/조회)
                                           |
                                           v
                               +-------------------------+
                               |       API Gateway       |
                               +-----------+-------------+
                                           |
              +----------------------------+------------------------------+
              |                                                           |
      (명령 Command)                                                (조회 Query)
              |                                                           |
              v                                                           v
+-------------------------+                                 +-------------------------+
|    Point API Service    |-----(5. 실시간 잔액/내역 조회)----->|     Redis (Read #1)     |
| (Command/Query Handler) |                                 | (실시간 조회용 최적화 모델) |
+-------------------------+                                 +-------------------------+
              |                                                           ^
              | (1. DB Transaction 시작)                                  |
              |  - `point_events` 에 이벤트 INSERT                        |
              |  - `point_event_outbox` 에 발행할 이벤트 INSERT             |
              | (DB Transaction 종료)                                     |
              v                                                           |
+-------------------------+                                 (4a. 이벤트 수신 후 업데이트)
|   MySQL (Write Model)   |                                               |
| (Source of Truth)       |                                               |
+-------------------------+                                               |
              |                                                           |
              | (2. CDC (Debezium)가 `outbox` 테이블 변경 감지)             |
              v                                                           |
+-------------------------+                                               |
|          Kafka          |                                               |
|      (Message Bus)      |                                               |
+-------------------------+                                               |
              |                                                           |
              | (3. 이벤트 발행)                                          |
              v                                                           |
+-------------------------+                                               |
|  Event Consumer(s)      |-----------------------------------------------+
|      (Projector)        |
+-------------------------+
              |
              | (4b. 이벤트 수신 후 업데이트)
              v
+-------------------------+
|  Analytical DB (Read #2)|
| (분석/어드민 검색용 모델) |
+-----------+-------------+
            ^
            |
            | (6. 관리자/분석가 조회)
            |
+-------------------------+
|   Admin / BI Platform   |
+-------------------------+

```

## 흐름 설명

1.  **DB Transaction (명령)**: `Point API`는 데이터 변경 요청을 받으면, **하나의 DB 트랜잭션** 내에서 비즈니스 이벤트(`point_events`)와 발행할 이벤트(`point_event_outbox`)를 **MySQL(Write Model)**에 원자적으로 기록합니다.
2.  **CDC (Change Data Capture)**: Debezium과 같은 CDC 도구가 `outbox` 테이블의 변경을 실시간으로 감지하여 해당 이벤트를 **Kafka**로 보냅니다.
3.  **이벤트 발행**: Kafka는 이벤트를 해당 토픽으로 안전하게 발행합니다.
4.  **Read Model 업데이트**: **Event Consumer**들이 Kafka 토픽을 구독(subscribe)하여 이벤트를 수신하고, 각자의 목적에 맞는 **Read Model**을 업데이트합니다.
    *   **(4a)**: 실시간 API 응답을 위한 Consumer는 **Redis**의 데이터를 업데이트합니다.
    *   **(4b)**: 분석 및 검색을 위한 Consumer는 **분석용 DB**의 데이터를 업데이트합니다.
5.  **실시간 조회 (조회)**: 사용자의 잔액 조회 등 빠른 응답이 필요한 요청은 `Point API`가 **Redis(Read Model)**를 직접 조회하여 즉시 응답합니다.
6.  **분석 조회 (조회)**: 어드민의 복잡한 조건 검색이나 통계 데이터 요청은 **분석용 DB(Read Model)**를 조회하여 처리합니다.